upstream truck.biz.mobile {
	<%- @truckn_hosts.each_with_index do |addr, idx| %>
	server <%= addr %>:12000 max_fails=1 fail_timeout=10s;
	<%- end %>
}

upstream charge-n.mobile {
 	<%- @chargen_hosts.each_with_index do |addr, idx| %>
	server <%= addr %>:11011 max_fails=1 fail_timeout=10s;
	<%- end %>
}

server {
        listen       443;
        server_name     ~^api\.sell-n\.com$;

    root /srv/truck-n/api;
    access_log  /var/log/nginx/truck-n/api_truck-n_com-all main;

        ssl                  on;
        ssl_certificate      /usr/local/etc/nginx/keys/sell-n/api.sell-n.com.chained.crt;
        ssl_certificate_key  /usr/local/etc/nginx/keys/sell-n/api.sell-n.com.ssl.key.prv;

        ssl_session_timeout  5m;

        ssl_protocols  SSLv3 TLSv1;
        ssl_ciphers  HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers   on;

    location /metadata {
         return 404;
    }

    location /charge {
        add_header Cache-Control no-cache;
        proxy_pass http://charge-n.mobile;
        proxy_set_header HOST $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_redirect off;
        proxy_connect_timeout 45s;
        proxy_next_upstream error timeout invalid_header;
    }
    location / {
        if (-f $document_root/maintenance.html) {
                    return 503;
            }
        add_header Cache-Control no-cache;
        proxy_pass http://truck.biz.mobile;
        proxy_set_header HOST $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_redirect off;
        proxy_connect_timeout 45s;
        proxy_next_upstream error timeout invalid_header;
        client_body_buffer_size 1024k;
    }
    location /nginx_status {
            # copied from http://blog.kovyrin.net/2006/04/29/monitoring-nginx-with-rrdtool/
            stub_status on;
            access_log   on;
            allow 127.0.0.1;
            deny all;
        }
}

server {
        listen       443;
        server_name   ~^api\.truck-n\.com$;

        root /srv/truck-n/api;
        access_log  /var/log/nginx/truck-n/api_truck-n_com-all main;

        ssl                  on;
        ssl_certificate      /usr/local/etc/nginx/keys/truck-n/api/api.truck-n.com.chained.crt;
        ssl_certificate_key  /usr/local/etc/nginx/keys/truck-n/api/api.truck-n.com.key;

        ssl_session_timeout  5m;

        ssl_protocols  SSLv3 TLSv1;
        ssl_ciphers  HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers   on;

    location /metadata {
         return 404;
    }

    location /charge {
        add_header Cache-Control no-cache;
        proxy_pass http://charge-n.mobile;
        proxy_set_header HOST $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_redirect off;
        proxy_connect_timeout 45s;
        proxy_next_upstream error timeout invalid_header;
    }
    location / {
        if (-f $document_root/maintenance.html) {
                    return 503;
            }
        add_header Cache-Control no-cache;
        proxy_pass http://truck.biz.mobile;
        proxy_set_header HOST $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_redirect off;
        proxy_connect_timeout 45s;
        proxy_next_upstream error timeout invalid_header;
        client_body_buffer_size 1024k;
    }
    location /nginx_status {
            # copied from http://blog.kovyrin.net/2006/04/29/monitoring-nginx-with-rrdtool/
            stub_status on;
            access_log   on;
            allow 127.0.0.1;
            deny all;
        }
}


